<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Media Hover/Click Scatter</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    #plot {
      width: 90vw;
      height: 90vh;
      margin: auto;
    }
  </style>
</head>
<body>
  <div id="plot"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const folder = params.get("folder") || "res/shapes";
    const csvPath = `${folder}/diagram.csv`;

    fetch(csvPath)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.text();
      })
      .then(text => {
        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
        const header = rows.shift();

        const idxMedia = header.indexOf('img_src');
        const idxX = header.indexOf('x');
        const idxY = header.indexOf('y');
        if (idxMedia === -1 || idxX === -1 || idxY === -1) {
          throw new Error("CSV header must contain: img_src,x,y");
        }

        const x = [], y = [], hoverMedia = [];
        rows.forEach(r => {
          const xi = parseFloat(r[idxX]);
          const yi = parseFloat(r[idxY]);
          if (!isNaN(xi) && !isNaN(yi)) {
            x.push(xi);
            y.push(yi);
            let src = r[idxMedia].trim();
            if (!/^https?:\/\//.test(src) && !src.startsWith("/") && !src.includes("/"))
              src = `${folder}/${src}`;
            hoverMedia.push(src);
          }
        });

        const defaultMarkerSize = 10;
        const hoverMarkerSize = 16;
        const defaultMarkerColor = 'teal';
        const hoverMarkerColor = 'teal';
        const markerSizes = new Array(x.length).fill(defaultMarkerSize);
        const markerColors = new Array(x.length).fill(defaultMarkerColor);

        const trace = {
          x, y,
          mode: 'markers',
          type: 'scatter',
          customdata: hoverMedia,
          hoverinfo: 'none',
          marker: { size: markerSizes, color: markerColors }
        };
        const layout = {
          title: 'Hover or click to see media',
          xaxis: { title: 'X' },
          yaxis: { title: 'Y' },
          annotations: [],
          hovermode: 'closest'
        };
        Plotly.newPlot('plot', [trace], layout);
        const plotDiv = document.getElementById('plot');

        const hoverDiv = document.createElement('div');
        hoverDiv.style.position = 'absolute';
        hoverDiv.style.pointerEvents = 'none';
        hoverDiv.style.display = 'none';
        hoverDiv.style.border = '1px solid black';
        hoverDiv.style.background = 'white';
        hoverDiv.style.padding = '5px';
        hoverDiv.style.zIndex = 1000;
        hoverDiv.style.textAlign = 'center';
        hoverDiv.style.fontFamily = 'Arial, sans-serif';
        hoverDiv.style.fontSize = '12px';
        hoverDiv.style.color = '#333';
        document.body.appendChild(hoverDiv);

        let lastHoverIndex = null;
        let pinnedIndex = null;

        function showMedia(point, xClient, yClient) {
          const src = point.customdata;
          const idx = point.pointIndex;

          if (lastHoverIndex !== null && lastHoverIndex !== idx) {
            markerSizes[lastHoverIndex] = defaultMarkerSize;
            markerColors[lastHoverIndex] = defaultMarkerColor;
          }
          markerSizes[idx] = hoverMarkerSize;
          markerColors[idx] = hoverMarkerColor;
          lastHoverIndex = idx;

          Plotly.restyle(plotDiv, {
            'marker.size': [markerSizes],
            'marker.color': [markerColors]
          });

          const filename = src.split('/').pop();
          const lower = filename.toLowerCase();
          let mediaHTML = "";
          if (/\.(png|jpg|jpeg|gif|webp)$/i.test(lower))
            mediaHTML = `<img src="${src}" style="max-width:200px; max-height:200px; display:block; margin-bottom:4px;">`;
          else if (/\.(mp4|webm|ogg)$/i.test(lower))
            mediaHTML = `<video src="${src}" autoplay muted loop style="max-width:200px; max-height:200px; display:block; margin-bottom:4px;"></video>`;
          else
            mediaHTML = `<div style="color:red">Unsupported file: ${filename}</div>`;

          hoverDiv.innerHTML = `${mediaHTML}`;
          hoverDiv.style.display = 'block';
          hoverDiv.style.left = (xClient + 15) + 'px';
          hoverDiv.style.top = (yClient + 15) + 'px';

          const update = {
            annotations: [
              {
                x: point.x,
                yref: 'paper',
                y: 0,
                xanchor: 'center',
                yanchor: 'top',
                text: `x: ${point.x}`,
                showarrow: false,
                font: { size: 12, color: 'black' },
                bgcolor: 'rgba(255,255,255,0.8)',
                bordercolor: 'black',
                borderwidth: 1,
              },
              {
                y: point.y,
                xref: 'paper',
                x: 1,
                yanchor: 'middle',
                xanchor: 'left',
                text: `y: ${point.y}`,
                showarrow: false,
                font: { size: 12, color: 'black' },
                bgcolor: 'rgba(255,255,255,0.8)',
                bordercolor: 'black',
                borderwidth: 1,
              }
            ]
          };
          Plotly.relayout(plotDiv, update);
        }

        function hideMedia() {
          if (pinnedIndex !== null) return; // keep showing if pinned
          hoverDiv.style.display = 'none';
          if (lastHoverIndex !== null) {
            markerSizes[lastHoverIndex] = defaultMarkerSize;
            markerColors[lastHoverIndex] = defaultMarkerColor;
            Plotly.restyle(plotDiv, {
              'marker.size': [markerSizes],
              'marker.color': [markerColors]
            });
            lastHoverIndex = null;
          }
          Plotly.relayout(plotDiv, { annotations: [] });
        }

        plotDiv.on('plotly_hover', ev => {
          if (pinnedIndex !== null) return; // don't override pinned media
          const pt = ev.points[0];
          showMedia(pt, ev.event.clientX, ev.event.clientY);
        });

        plotDiv.on('plotly_unhover', () => hideMedia());

        plotDiv.on('plotly_click', ev => {
          const pt = ev.points[0];
          const idx = pt.pointIndex;
          // toggle pinning
          if (pinnedIndex === idx) {
            pinnedIndex = null;
            hideMedia();
          } else {
            pinnedIndex = idx;
            showMedia(pt, ev.event.clientX, ev.event.clientY);
          }
        });

        document.body.addEventListener('click', e => {
          // click outside unpins
          if (!plotDiv.contains(e.target)) {
            pinnedIndex = null;
            hideMedia();
          }
        });
      })
      .catch(err => {
        console.error("Failed to load or parse CSV:", err);
        document.body.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      });
  </script>
</body>
</html>
